<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Edit Profile</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/sidebar.css">
    <link rel="stylesheet" href="/static/admin_profile.css">
</head>

<body>
    <div class="wrapper">
        {{template "admin_sidebar" .}}

        <main class="content-area">
            <div class="container py-4">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card shadow-sm position-relative">
                            <div class="loading-overlay" id="cardLoadingOverlay" role="status"
                                aria-label="Loading profile data">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>

                            <div
                                class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h1 class="mb-0 fs-4">Edit Admin Profile</h1>
                                <a href="/admin/profile/view" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-eye"></i> View Profile
                                </a>
                            </div>
                            <div class="card-body">
                                <div id="profile-message" class="alert d-none" role="status" aria-live="polite">
                                </div>

                                <form id="profileUpdateForm" enctype="multipart/form-data" novalidate>
                                    <fieldset>
                                        <legend class="visually-hidden">Update Profile Information</legend>
                                        <div class="text-center mb-4">
                                            <div class="profile-pic-wrapper">
                                                <img id="profilePicPreview" src="/static/images/default_profile_pic.png"
                                                    alt="Current Profile Picture"
                                                    class="profile-pic-preview img-thumbnail rounded-circle">
                                                <label for="profilePicInput"
                                                    class="profile-pic-label btn btn-sm btn-light position-absolute bottom-0 end-0 rounded-circle p-2"
                                                    title="Change Profile Picture">
                                                    <i class="fas fa-camera"></i>
                                                    <span class="visually-hidden">Change Profile Picture</span>
                                                </label>
                                                <input type="file" id="profilePicInput" name="profile_pic"
                                                    accept="image/*" class="form-control-file d-none">
                                            </div>
                                            <small class="form-text text-muted">Max file size: 2MB</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="name" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="name" name="name" required
                                                aria-describedby="nameHelp" placeholder="Enter your full name">
                                            <div id="nameHelp" class="form-text">Your public display name.</div>
                                            <div class="invalid-feedback">Please enter your name.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" name="email" required
                                                aria-describedby="emailHelp" placeholder="Enter your email address">
                                            <div id="emailHelp" class="form-text">We'll never share your email with
                                                anyone else.</div>
                                            <div class="invalid-feedback">Please enter a valid email address.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="phone" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="phone" name="phone"
                                                aria-describedby="phoneHelp" placeholder="e.g., +15551234567"
                                                pattern="^\+?[1-9]\d{1,14}$">
                                            <div id="phoneHelp" class="form-text">Optional phone number.</div>
                                            <div class="invalid-feedback">Please enter a valid phone number (e.g.,
                                                +15551234567).</div>
                                        </div>
                                        <button type="submit" class="btn btn-primary" id="updateProfileBtn">Update
                                            Profile</button>
                                    </fieldset>
                                </form>

                                <hr class="my-4">

                                <h2 class="mb-3 fs-5">Change Password</h2>
                                <form id="passwordChangeForm" novalidate>
                                    <fieldset>
                                        <legend class="visually-hidden">Change Account Password</legend>
                                        <div id="password-message" class="alert d-none" role="status"
                                            aria-live="polite">
                                        </div>
                                        <div class="mb-3">
                                            <label for="oldPassword" class="form-label">Current Password</label>
                                            <input type="password" class="form-control" id="oldPassword"
                                                name="old_password" required autocomplete="current-password">
                                            <div class="invalid-feedback">Please enter your current password.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="newPassword"
                                                name="new_password" required minlength="8"
                                                pattern="^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+=\-{}\[\]:;<>,.?~\\|]).{8,}$"
                                                aria-describedby="newPasswordHelp" autocomplete="new-password">
                                            <div id="newPasswordHelp" class="form-text">
                                                Must be at least 8 characters long, contain an uppercase letter, a
                                                lowercase letter, a number, and a special character.
                                            </div>
                                            <div class="invalid-feedback">New password must be at least 8 characters
                                                long and include uppercase, lowercase, a number, and a special
                                                character.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="confirmNewPassword" class="form-label">Confirm New
                                                Password</label>
                                            <input type="password" class="form-control" id="confirmNewPassword"
                                                name="confirm_new_password" required minlength="8"
                                                autocomplete="new-password">
                                            <div class="invalid-feedback">New passwords do not match.</div>
                                        </div>
                                        <button type="submit" class="btn btn-warning" id="changePasswordBtn">Change
                                            Password</button>
                                    </fieldset>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS (bundle includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>

    <!-- Your custom JavaScript for edit page -->
    <script>
        (function () {
            const DOM = {
                cardLoadingOverlay: document.getElementById('cardLoadingOverlay'),
                profilePicInput: document.getElementById('profilePicInput'),
                profilePicPreview: document.getElementById('profilePicPreview'),
                profileUpdateForm: document.getElementById('profileUpdateForm'),
                profileMessageDiv: document.getElementById('profile-message'),
                nameInput: document.getElementById('name'),
                emailInput: document.getElementById('email'),
                phoneInput: document.getElementById('phone'),
                updateProfileBtn: document.getElementById('updateProfileBtn'),

                passwordChangeForm: document.getElementById('passwordChangeForm'),
                oldPasswordInput: document.getElementById('oldPassword'),
                newPasswordInput: document.getElementById('newPassword'),
                confirmNewPasswordInput: document.getElementById('confirmNewPassword'),
                passwordMessageDiv: document.getElementById('password-message'),
                changePasswordBtn: document.getElementById('changePasswordBtn'),
            };

            const API_ENDPOINTS = {
                PROFILE: '/admin/api/profile',
                PASSWORD_CHANGE: '/admin/api/profile/password',
            };

            const DEFAULT_PROFILE_PIC = '/static/images/default_profile_pic.png';
            const MESSAGE_TIMEOUT_MS = 5000;

            const toggleLoadingState = (button, show) => {
                if (button) {
                    button.disabled = show;
                    button.innerHTML = show
                        ? `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`
                        : button.dataset.originalText || button.textContent;
                    if (!button.dataset.originalText) {
                        button.dataset.originalText = button.textContent;
                    }
                }
                if (DOM.cardLoadingOverlay) {
                    DOM.cardLoadingOverlay.classList.toggle('active', show);
                }
            };

            const showAlert = (alertDiv, type, message) => {
                if (!alertDiv) return;
                alertDiv.className = 'alert';
                alertDiv.classList.add(`alert-${type}`);
                alertDiv.textContent = message;
                alertDiv.setAttribute('role', 'alert');
                alertDiv.classList.remove('d-none', 'fade', 'show');
                void alertDiv.offsetWidth;
                alertDiv.classList.add('show');
                clearTimeout(alertDiv.dataset.hideTimeout);
                alertDiv.dataset.hideTimeout = setTimeout(() => {
                    alertDiv.classList.remove('show');
                    alertDiv.classList.add('fade');
                    const handleTransitionEnd = () => {
                        alertDiv.classList.add('d-none');
                        alertDiv.classList.remove('fade');
                        alertDiv.removeEventListener('transitionend', handleTransitionEnd);
                    };
                    alertDiv.addEventListener('transitionend', handleTransitionEnd, { once: true });
                }, MESSAGE_TIMEOUT_MS);
            };

            const clearAlert = (alertDiv) => {
                if (alertDiv) {
                    clearTimeout(alertDiv.dataset.hideTimeout);
                    alertDiv.classList.add('d-none');
                    alertDiv.classList.remove('show', 'fade');
                    alertDiv.removeAttribute('role');
                    alertDiv.textContent = '';
                }
            };

            const handleValidationFeedback = (form, isValid) => {
                form.classList.toggle('was-validated', !isValid);
            };

            async function fetchJson(url, options = {}, button = null) {
                toggleLoadingState(button, true);
                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    if (!response.ok) {
                        const errorMessage = data.error || data.message || `HTTP error! Status: ${response.status}`;
                        throw new Error(errorMessage);
                    }
                    return data;
                } finally {
                    toggleLoadingState(button, false);
                }
            }

            async function fetchAdminProfileForEdit() {
                try {
                    const data = await fetchJson(API_ENDPOINTS.PROFILE + '/view'); // Fetch using the view API
                    DOM.nameInput.value = data.name || '';
                    DOM.emailInput.value = data.email || '';
                    DOM.phoneInput.value = data.phone || '';
                    DOM.profilePicPreview.src = data.profile_pic ? data.profile_pic : DEFAULT_PROFILE_PIC;
                    clearAlert(DOM.profileMessageDiv);
                } catch (error) {
                    console.error('Error fetching admin profile:', error);
                    showAlert(DOM.profileMessageDiv, 'danger', `Failed to load profile for editing: ${error.message}`);
                    // Disable forms if loading fails
                    DOM.profileUpdateForm.querySelectorAll('input, button').forEach(el => el.disabled = true);
                    DOM.passwordChangeForm.querySelectorAll('input, button').forEach(el => el.disabled = true);
                }
            }

            function handleProfilePicChange() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    const maxFileSize = 2 * 1024 * 1024;

                    if (file.size > maxFileSize) {
                        showAlert(DOM.profileMessageDiv, 'danger', 'Profile picture size exceeds 2MB limit.');
                        this.value = '';
                        // Do not reset to default here, keep current pic if it was valid, or default if none
                        // For simplicity, we might re-fetch profile data or keep the old preview
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => DOM.profilePicPreview.src = e.target.result;
                    reader.readAsDataURL(file);
                } else {
                    // If no new file is selected, the existing one should remain.
                    // To truly revert to the _original_ picture if user cancels, you'd need to store it.
                    // For now, if user selects then cancels, the preview might stay as the last valid selection.
                    // A re-fetch would ensure it goes back to the server's version.
                    fetchAdminProfileForEdit(); // Re-fetch to reset the preview to the server's current pic
                }
            }

            async function handleProfileUpdate(e) {
                e.preventDefault();
                clearAlert(DOM.profileMessageDiv);

                if (!this.checkValidity()) {
                    handleValidationFeedback(this, false);
                    showAlert(DOM.profileMessageDiv, 'danger', 'Please fill in all required fields correctly.');
                    return;
                }
                handleValidationFeedback(this, true);

                const formData = new FormData(this);

                try {
                    const result = await fetchJson(API_ENDPOINTS.PROFILE + '/edit', { // Note: using specific edit API
                        method: 'PUT',
                        body: formData,
                    }, DOM.updateProfileBtn);
                    showAlert(DOM.profileMessageDiv, 'success', result.message || 'Profile updated successfully!');
                    await fetchAdminProfileForEdit(); // Reload profile to reflect changes, especially new pic
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showAlert(DOM.profileMessageDiv, 'danger', `Failed to update profile: ${error.message}`);
                }
            }

            function validatePasswordFields() {
                const newPassword = DOM.newPasswordInput.value;
                const confirmNewPassword = DOM.confirmNewPasswordInput.value;
                const passwordPattern = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+=\-{}\[\]:;<>,.?~\\|]).{8,}$/;

                let isValid = true;

                DOM.newPasswordInput.setCustomValidity('');
                DOM.confirmNewPasswordInput.setCustomValidity('');

                if (!passwordPattern.test(newPassword)) {
                    DOM.newPasswordInput.setCustomValidity('New password does not meet requirements.');
                    isValid = false;
                }

                if (newPassword !== confirmNewPassword) {
                    DOM.confirmNewPasswordInput.setCustomValidity('Passwords do not match.');
                    isValid = false;
                }

                DOM.passwordChangeForm.classList.toggle('was-validated', !isValid);

                return isValid && DOM.passwordChangeForm.checkValidity();
            }

            async function handlePasswordChange(e) {
                e.preventDefault();
                clearAlert(DOM.passwordMessageDiv);

                if (!validatePasswordFields()) {
                    showAlert(DOM.passwordMessageDiv, 'danger', 'Please correct the errors in the password fields.');
                    return;
                }

                const oldPassword = DOM.oldPasswordInput.value;
                const newPassword = DOM.newPasswordInput.value;

                try {
                    const result = await fetchJson(API_ENDPOINTS.PASSWORD_CHANGE, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ old_password: oldPassword, new_password: newPassword }),
                    }, DOM.changePasswordBtn);
                    showAlert(DOM.passwordMessageDiv, 'success', result.message || 'Password changed successfully!');
                    DOM.passwordChangeForm.reset();
                    handleValidationFeedback(DOM.passwordChangeForm, false);
                } catch (error) {
                    console.error('Error changing password:', error);
                    showAlert(DOM.passwordMessageDiv, 'danger', `Failed to change password: ${error.message}`);
                }
            }

            function initializeEventListeners() {
                DOM.profilePicInput.addEventListener('change', handleProfilePicChange);
                DOM.profileUpdateForm.addEventListener('submit', handleProfileUpdate);

                DOM.oldPasswordInput.addEventListener('input', () => DOM.passwordChangeForm.checkValidity());
                DOM.newPasswordInput.addEventListener('input', validatePasswordFields);
                DOM.confirmNewPasswordInput.addEventListener('input', validatePasswordFields);
                DOM.passwordChangeForm.addEventListener('submit', handlePasswordChange);
            }

            document.addEventListener('DOMContentLoaded', () => {
                initializeEventListeners();
                fetchAdminProfileForEdit();
            });

        })();
    </script>
</body>

</html>