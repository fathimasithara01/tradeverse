<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{.Title}}</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

 <style>
        :root {
            --sidebar-bg: #ffffff;
            --sidebar-width: 280px;
            --main-bg: #f7f9fc;
            --brand-color: #1a73e8;
            --text-color: #343a40;
            --link-color: #5f6368;
            --link-hover-bg: #f1f3f4;
            --link-active-bg: #e8f0fe;
            --link-active-color: #1967d2;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.08);

            /* Status badge colors */
            --status-active-bg: #e6ffed; /* Light green */
            --status-active-color: #007f35; /* Dark green */
            --status-pending-bg: #fffbe6; /* Light yellow */
            --status-pending-color: #7a5c00; /* Dark yellow */
            --status-expired-bg: #ffe6e6; /* Light red */
            --status-expired-color: #990000; /* Dark red */
            --status-inactive-bg: #e9ecef; /* Light gray */
            --status-inactive-color: #495057; /* Dark gray */
            --status-approved-bg: #e6ffed; /* Light green */
            --status-approved-color: #007f35; /* Dark green */
            --status-rejected-bg: #ffe6e6; /* Light red */
            --status-rejected-color: #990000; /* Dark red */
            --status-pending-approval-bg: #fffbe6; /* Light yellow */
            --status-pending-approval-color: #7a5c00; /* Dark yellow */
        }

        body {
            background-color: var(--main-bg);
            font-family: 'Inter', sans-serif;
            margin: 0; /* Ensure no default body margin */
        }

        .wrapper {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        #sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: var(--sidebar-bg);
            transition: all 0.3s;
            box-shadow: 0 0 25px var(--shadow-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.25rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h3 {
            color: var(--brand-color);
            font-weight: 700;
            margin-bottom: 0;
            font-size: 1.5rem;
        }

        #sidebar-nav {
            flex-grow: 1;
            padding: 1rem 0;
            overflow-y: auto; /* Enable scrolling for long sidebars */
        }

        #sidebar-nav .nav-heading {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #adb5bd;
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        #sidebar-nav .nav-item a {
            padding: 0.8rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            color: var(--link-color);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        #sidebar-nav .nav-item a:hover {
            background: var(--link-hover-bg);
            color: var(--text-color);
        }

        #sidebar-nav .nav-item.active>a,
        #sidebar-nav .nav-item a[aria-expanded="true"] {
            background: var(--link-active-bg);
            color: var(--link-active-color);
            border-left-color: var(--link-active-color);
        }

        #sidebar-nav .nav-item a i {
            margin-right: 1rem;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .collapse-arrow {
            margin-left: auto;
            transition: transform 0.2s ease-in-out;
        }

        a[aria-expanded="true"] .collapse-arrow {
            transform: rotate(90deg);
        }

        .nav-collapse .nav-item a {
            padding-left: 3.8rem !important;
            font-size: 0.9rem;
            border-left: none;
            position: relative;
            color: #6c757d;
        }

        .nav-collapse .nav-item.active a {
            color: var(--link-active-color);
            font-weight: 600;
        }

        .sidebar-footer {
            border-top: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }

        #content {
            flex-grow: 1;
            padding: 2.5rem;
            overflow-x: auto; /* Allow horizontal scrolling for table */
        }

        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }

        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-card .title {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .table-responsive {
            overflow-x: auto;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: .35em .65em;
            font-size: .75em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: .375rem;
            margin-bottom: 0; /* Ensure no extra margin from parent */
        }

        .status-active, .status-approved {
            color: var(--status-active-color);
            background-color: var(--status-active-bg);
        }

        .status-pending, .status-pending-approval {
            color: var(--status-pending-color);
            background-color: var(--status-pending-bg);
        }

        .status-expired, .status-rejected {
            color: var(--status-expired-color);
            background-color: var(--status-expired-bg);
        }

        .status-inactive {
            color: var(--status-inactive-color);
            background-color: var(--status-inactive-bg);
        }
    </style>
</head>

<body class="bg-light">
  <div class="wrapper">
    {{template "admin_sidebar" .}}

    <div id="content">
      <h2 class="mb-4">{{.Title}}</h2>

      <div class="table-responsive">
        <table class="table table-bordered table-hover text-center align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Customer Name</th>
              <th>Trader Name</th>
              <th>Trader Status</th>
              <th>Plan</th>
              <th>Subscription Status</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="subscriptions-table">
            <tr>
              <td colspan="9" class="text-muted">Fetching subscriptions...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script>
    function getStatusBadge(status) {
      let badgeClass = '';
      let statusText = status;

      switch (status) {
        case 'active':
          badgeClass = 'status-active';
          break;
        case 'expired':
          badgeClass = 'status-expired';
          break;
        case 'paid': // Often 'paid' implies active
          badgeClass = 'status-active';
          statusText = 'Active';
          break;
        case 'pending':
          badgeClass = 'status-pending';
          break;
        case 'approved':
          badgeClass = 'status-approved';
          break;
        case 'rejected':
          badgeClass = 'status-rejected';
          break;
        case 'pending_approval':
          badgeClass = 'status-pending-approval';
          statusText = 'Pending Approval';
          break;
        default:
          badgeClass = 'status-inactive';
          statusText = status || 'Unknown';
          break;
      }

      return `<span class="status-badge ${badgeClass}">
                ${statusText.charAt(0).toUpperCase() + statusText.slice(1)}
              </span>`;
    }

    async function fetchSubscriptions() {
      try {
        const res = await fetch('/admin/financials/api/subscriptions');
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Failed to fetch data: ${res.status} - ${errorText}`);
        }

        const subscriptions = await res.json();
        const tableBody = document.getElementById("subscriptions-table");
        tableBody.innerHTML = ""; // Clear loading message

        if (subscriptions.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="9" class="text-muted">No subscriptions found.</td></tr>`;
          return;
        }

        subscriptions.forEach(sub => {
          const customerName = sub.user?.name || 'N/A';
          const planName = sub.subscription_plan?.name || 'N/A';
          // Determine subscription status more robustly
          const subscriptionStatus = sub.is_active ? 'active' : (sub.payment_status || 'inactive');

          const isTrader = sub.user?.trader_profile && sub.user.trader_profile.user_id !== 0;
          const traderName = isTrader ? (sub.user.trader_profile.trader_name || 'N/A') : 'N/A';
          const traderProfileStatus = isTrader ? sub.user.trader_profile.status : null;
          const traderStatusDisplay = isTrader
            ? getStatusBadge(traderProfileStatus)
            : '<span class="text-muted">Not a Trader</span>';

          let actionsHtml = '';
          if (sub.user && sub.user.id) {
            if (isTrader) {
              switch (traderProfileStatus) {
                case 'approved':
                  actionsHtml = '<span class="status-badge status-approved">Trader Approved</span>';
                  break;
                case 'pending_approval':
                  actionsHtml = `
                    <button class="btn btn-sm btn-success me-2" 
                            onclick="updateTraderStatus(${sub.user.id}, 'approved')">
                      Approve
                    </button>
                    <button class="btn btn-sm btn-danger" 
                            onclick="updateTraderStatus(${sub.user.id}, 'rejected')">
                      Reject
                    </button>`;
                  break;
                case 'rejected':
                  actionsHtml = `
                    <span class="status-badge status-rejected me-2">Trader Rejected</span>
                    <button class="btn btn-sm btn-success" 
                            onclick="updateTraderStatus(${sub.user.id}, 'approved')">
                      Approve Anyway
                    </button>`;
                  break;
                default:
                  actionsHtml = '<span class="text-muted">N/A</span>';
                  break;
              }
            } else {
              actionsHtml = '<span class="text-muted">N/A (Not a Trader)</span>';
            }
          } else {
            actionsHtml = '<span class="text-muted">User Data Missing</span>';
          }

          const row = `
            <tr>
              <td>${sub.ID}</td>
              <td>${customerName}</td>
              <td>${traderName}</td>
              <td>${traderStatusDisplay}</td>
              <td>${planName}</td>
              <td>${getStatusBadge(subscriptionStatus)}</td>
              <td>${new Date(sub.start_date).toLocaleDateString()}</td>
              <td>${new Date(sub.end_date).toLocaleDateString()}</td>
              <td>${actionsHtml}</td>
            </tr>`;
          tableBody.innerHTML += row;
        });
      } catch (err) {
        console.error("Error fetching subscriptions:", err);
        document.getElementById("subscriptions-table").innerHTML =
          `<tr><td colspan="9" class="text-danger">Error loading data: ${err.message}. Please check console for details.</td></tr>`;
      }
    }

    async function updateTraderStatus(userId, status) {
      if (!confirm(`Are you sure you want to set this user's trader status to '${status}'?`)) return;

      try {
        // Corrected endpoint for admin trader status update
        const res = await fetch(`/admin/financials/api/traders/${userId}/status`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: status })
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Failed to update trader status: ${res.status} - ${errorText}`);
        }

        alert(`Trader status updated to '${status}' successfully!`);
        fetchSubscriptions(); // Refresh table
      } catch (err) {
        console.error("Error updating trader status:", err);
        alert("Error: " + err.message);
      }
    }

    // Load subscriptions on page load
    document.addEventListener('DOMContentLoaded', fetchSubscriptions);
  </script>
</body>

</html>