<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{.Title}}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/sidebar.css">
      <link rel="stylesheet" href="/static/admin_subscriptions.css">

</head>

<body>
  <div class="wrapper">
    {{template "admin_sidebar" .}}

    <div id="content">
      <h2 class="mb-4">{{.Title}}</h2>

      <div class="card p-0">
        <div class="card-header">
          Subscriptions Overview
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover text-center align-middle mb-0">
              <thead class="text-white"> <!-- Removed Bootstrap bg-primary, now handled by custom CSS -->
                <tr>
                  <th>ID</th>
                  <th>Customer Name</th>
                  <th>Trader Name</th>
                  <th>Trader Status</th>
                  <th>Plan</th>
                  <th>Subscription Status</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="subscriptions-table">
                <tr>
                  <td colspan="9" class="text-muted">Fetching subscriptions...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script>
    function getStatusBadge(status) {
      let badgeClass = '';
      let statusText = status;

      switch (status) {
        case 'active':
          badgeClass = 'status-active';
          break;
        case 'expired':
          badgeClass = 'status-expired';
          break;
        case 'paid': // Often 'paid' implies active
          badgeClass = 'status-active';
          statusText = 'Active';
          break;
        case 'pending':
          badgeClass = 'status-pending';
          break;
        case 'approved':
          badgeClass = 'status-approved';
          break;
        case 'rejected':
          badgeClass = 'status-rejected';
          break;
        case 'pending_approval':
          badgeClass = 'status-pending-approval';
          statusText = 'Pending Approval';
          break;
        default:
          badgeClass = 'status-inactive';
          statusText = status || 'Unknown';
          break;
      }

      return `<span class="status-badge ${badgeClass}">
                ${statusText.charAt(0).toUpperCase() + statusText.slice(1)}
              </span>`;
    }

    async function fetchSubscriptions() {
      try {
        const res = await fetch('/admin/financials/api/subscriptions');
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Failed to fetch data: ${res.status} - ${errorText}`);
        }

        const subscriptions = await res.json();
        const tableBody = document.getElementById("subscriptions-table");
        tableBody.innerHTML = ""; // Clear loading message

        if (subscriptions.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="9" class="text-muted">No subscriptions found.</td></tr>`;
          return;
        }

        subscriptions.forEach(sub => {
          const customerName = sub.user?.name || 'N/A';
          const planName = sub.subscription_plan?.name || 'N/A';
          // Determine subscription status more robustly
          const subscriptionStatus = sub.is_active ? 'active' : (sub.payment_status || 'inactive');

          const isTrader = sub.user?.trader_profile && sub.user.trader_profile.user_id !== 0;
          const traderName = isTrader ? (sub.user.trader_profile.trader_name || 'N/A') : 'N/A';
          const traderProfileStatus = isTrader ? sub.user.trader_profile.status : null;
          const traderStatusDisplay = isTrader
            ? getStatusBadge(traderProfileStatus)
            : '<span class="text-muted">Not a Trader</span>';

          let actionsHtml = '';
          if (sub.user && sub.user.id) {
            if (isTrader) {
              switch (traderProfileStatus) {
                case 'approved':
                  actionsHtml = '<span class="status-badge status-approved">Trader Approved</span>';
                  break;
                case 'pending_approval':
                  actionsHtml = `
                    <button class="btn btn-sm btn-success me-2"
                            onclick="updateTraderStatus(${sub.user.id}, 'approved')">
                      Approve
                    </button>
                    <button class="btn btn-sm btn-danger"
                            onclick="updateTraderStatus(${sub.user.id}, 'rejected')">
                      Reject
                    </button>`;
                  break;
                case 'rejected':
                  actionsHtml = `
                    <span class="status-badge status-rejected me-2">Trader Rejected</span>
                    <button class="btn btn-sm btn-success"
                            onclick="updateTraderStatus(${sub.user.id}, 'approved')">
                      Approve Anyway
                    </button>`;
                  break;
                default:
                  actionsHtml = '<span class="text-muted">N/A</span>';
                  break;
              }
            } else {
              actionsHtml = '<span class="text-muted">N/A (Not a Trader)</span>';
            }
          } else {
            actionsHtml = '<span class="text-muted">User Data Missing</span>';
          }

          const row = `
            <tr>
              <td>${sub.ID}</td>
              <td>${customerName}</td>
              <td>${traderName}</td>
              <td>${traderStatusDisplay}</td>
              <td>${planName}</td>
              <td>${getStatusBadge(subscriptionStatus)}</td>
              <td>${new Date(sub.start_date).toLocaleDateString()}</td>
              <td>${new Date(sub.end_date).toLocaleDateString()}</td>
              <td>${actionsHtml}</td>
            </tr>`;
          tableBody.innerHTML += row;
        });
      } catch (err) {
        console.error("Error fetching subscriptions:", err);
        document.getElementById("subscriptions-table").innerHTML =
          `<tr><td colspan="9" class="text-danger">Error loading data: ${err.message}. Please check console for details.</td></tr>`;
      }
    }

    async function updateTraderStatus(userId, status) {
      if (!confirm(`Are you sure you want to set this user's trader status to '${status}'?`)) return;

      try {
        // Corrected endpoint for admin trader status update
        const res = await fetch(`/admin/financials/api/traders/${userId}/status`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: status })
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Failed to update trader status: ${res.status} - ${errorText}`);
        }

        alert(`Trader status updated to '${status}' successfully!`);
        fetchSubscriptions(); // Refresh table
      } catch (err) {
        console.error("Error updating trader status:", err);
        alert("Error: " + err.message);
      }
    }

    // Load subscriptions on page load
    document.addEventListener('DOMContentLoaded', fetchSubscriptions);
  </script>
</body>

</html>