<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{.Title}}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/sidebar.css">

  <style>
    h2 {
      color: var(--text-heading);
      font-weight: var(--font-weight-bold);
      font-size: 1.75rem;
      margin-bottom: var(--spacing-xl);
    }

    /* Cards */
    .card {
      border: 1px solid var(--border-light);
      /* Explicit border for definition */
      border-radius: var(--border-radius-lg);
      /* More rounded corners */
      box-shadow: 0 4px 15px var(--shadow-subtle);
      /* Very subtle shadow */
      margin-bottom: var(--spacing-xl);
      /* More space between cards */
      background-color: var(--bg-card);
    }

    .card-header {
      background-color: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      font-weight: var(--font-weight-semibold);
      padding: var(--spacing-lg);
      font-size: var(--font-size-large);
      color: var(--text-heading);
      border-top-left-radius: var(--border-radius-lg);
      border-top-right-radius: var(--border-radius-lg);
    }

    .card-body {
      padding: var(--spacing-lg);
    }

    /* Tables (Bootstrap override for modern look) */
    .table {
      --bs-table-bg: var(--bg-card);
      --bs-table-color: var(--text-body);
      --bs-table-striped-bg: var(--bg-light);
      --bs-table-hover-bg: #f2f5f7;
      /* Very light hover */
      border: none;
      /* Removed outer border, card handles it */
      border-radius: var(--border-radius-lg);
      /* Consistent with card */
      overflow: hidden;
    }

    .table thead {
      background-color: var(--bg-light);
      /* Lighter header for a softer feel */
      color: var(--text-heading);
      border-bottom: 1px solid var(--border-light);
    }

    .table thead th {
      border-bottom: none;
      /* No border below header for cleaner look */
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--text-muted);
      /* Muted header text */
      vertical-align: middle;
    }

    .table tbody tr td {
      border-top: 1px solid var(--border-light);
      /* Light horizontal borders */
      border-bottom: none;
      padding: var(--spacing-md) var(--spacing-lg);
      vertical-align: middle;
      font-size: var(--font-size-base);
    }

    .table tbody tr:first-child td {
      border-top: none;
      /* No top border for first row */
    }


    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.3em 0.7em;
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      /* Align middle with text */
      border-radius: var(--border-radius-sm);
      /* Slightly less rounded than cards */
      text-transform: capitalize;
    }

    .status-badge::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 0.5rem;
      background-color: currentColor;
      /* Dot matches text color */
    }

    .status-active,
    .status-approved {
      color: var(--status-active-color);
      background-color: var(--status-active-bg);
    }

    .status-pending,
    .status-pending-approval {
      color: var(--status-pending-color);
      background-color: var(--status-pending-bg);
    }

    .status-expired,
    .status-rejected {
      color: var(--status-expired-color);
      background-color: var(--status-expired-bg);
    }

    .status-inactive {
      color: var(--status-inactive-color);
      background-color: var(--status-inactive-bg);
    }

    /* Buttons */
    .btn {
      font-weight: var(--font-weight-medium);
      border-radius: var(--border-radius-sm);
      /* Consistent with badges */
      padding: 0.45rem 1rem;
      font-size: var(--font-size-base);
      transition: all 0.2s ease;
    }

    .btn-sm {
      padding: 0.3rem 0.75rem;
      font-size: var(--font-size-small);
    }

    .btn-success {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      --bs-btn-hover-bg: #218838;
      --bs-btn-hover-border-color: #1e7e34;
    }

    .btn-danger {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
      --bs-btn-hover-bg: #c82333;
      --bs-btn-hover-border-color: #bd2130;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <!-- The "admin_sidebar" template would contain your sidebar HTML structure -->
    {{template "admin_sidebar" .}}

    <div id="content">
      <h2 class="mb-4">{{.Title}}</h2>

      <div class="card p-0">
        <div class="card-header">
          Subscriptions Overview
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover text-center align-middle mb-0">
              <thead class="text-white"> <!-- Removed Bootstrap bg-primary, now handled by custom CSS -->
                <tr>
                  <th>ID</th>
                  <th>Customer Name</th>
                  <th>Trader Name</th>
                  <th>Trader Status</th>
                  <th>Plan</th>
                  <th>Subscription Status</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="subscriptions-table">
                <tr>
                  <td colspan="9" class="text-muted">Fetching subscriptions...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script>
    function getStatusBadge(status) {
      let badgeClass = '';
      let statusText = status;

      switch (status) {
        case 'active':
          badgeClass = 'status-active';
          break;
        case 'expired':
          badgeClass = 'status-expired';
          break;
        case 'paid': // Often 'paid' implies active
          badgeClass = 'status-active';
          statusText = 'Active';
          break;
        case 'pending':
          badgeClass = 'status-pending';
          break;
        case 'approved':
          badgeClass = 'status-approved';
          break;
        case 'rejected':
          badgeClass = 'status-rejected';
          break;
        case 'pending_approval':
          badgeClass = 'status-pending-approval';
          statusText = 'Pending Approval';
          break;
        default:
          badgeClass = 'status-inactive';
          statusText = status || 'Unknown';
          break;
      }

      return `<span class="status-badge ${badgeClass}">
                ${statusText.charAt(0).toUpperCase() + statusText.slice(1)}
              </span>`;
    }

    async function fetchSubscriptions() {
      try {
        const res = await fetch('/admin/financials/api/subscriptions');
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Failed to fetch data: ${res.status} - ${errorText}`);
        }

        const subscriptions = await res.json();
        const tableBody = document.getElementById("subscriptions-table");
        tableBody.innerHTML = ""; // Clear loading message

        if (subscriptions.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="9" class="text-muted">No subscriptions found.</td></tr>`;
          return;
        }

        subscriptions.forEach(sub => {
          const customerName = sub.user?.name || 'N/A';
          const planName = sub.subscription_plan?.name || 'N/A';
          // Determine subscription status more robustly
          const subscriptionStatus = sub.is_active ? 'active' : (sub.payment_status || 'inactive');

          const isTrader = sub.user?.trader_profile && sub.user.trader_profile.user_id !== 0;
          const traderName = isTrader ? (sub.user.trader_profile.trader_name || 'N/A') : 'N/A';
          const traderProfileStatus = isTrader ? sub.user.trader_profile.status : null;
          const traderStatusDisplay = isTrader
            ? getStatusBadge(traderProfileStatus)
            : '<span class="text-muted">Not a Trader</span>';

          let actionsHtml = '';
          if (sub.user && sub.user.id) {
            if (isTrader) {
              switch (traderProfileStatus) {
                case 'approved':
                  actionsHtml = '<span class="status-badge status-approved">Trader Approved</span>';
                  break;
                case 'pending_approval':
                  actionsHtml = `
                    <button class="btn btn-sm btn-success me-2"
                            onclick="updateTraderStatus(${sub.user.id}, 'approved')">
                      Approve
                    </button>
                    <button class="btn btn-sm btn-danger"
                            onclick="updateTraderStatus(${sub.user.id}, 'rejected')">
                      Reject
                    </button>`;
                  break;
                case 'rejected':
                  actionsHtml = `
                    <span class="status-badge status-rejected me-2">Trader Rejected</span>
                    <button class="btn btn-sm btn-success"
                            onclick="updateTraderStatus(${sub.user.id}, 'approved')">
                      Approve Anyway
                    </button>`;
                  break;
                default:
                  actionsHtml = '<span class="text-muted">N/A</span>';
                  break;
              }
            } else {
              actionsHtml = '<span class="text-muted">N/A (Not a Trader)</span>';
            }
          } else {
            actionsHtml = '<span class="text-muted">User Data Missing</span>';
          }

          const row = `
            <tr>
              <td>${sub.ID}</td>
              <td>${customerName}</td>
              <td>${traderName}</td>
              <td>${traderStatusDisplay}</td>
              <td>${planName}</td>
              <td>${getStatusBadge(subscriptionStatus)}</td>
              <td>${new Date(sub.start_date).toLocaleDateString()}</td>
              <td>${new Date(sub.end_date).toLocaleDateString()}</td>
              <td>${actionsHtml}</td>
            </tr>`;
          tableBody.innerHTML += row;
        });
      } catch (err) {
        console.error("Error fetching subscriptions:", err);
        document.getElementById("subscriptions-table").innerHTML =
          `<tr><td colspan="9" class="text-danger">Error loading data: ${err.message}. Please check console for details.</td></tr>`;
      }
    }

    async function updateTraderStatus(userId, status) {
      if (!confirm(`Are you sure you want to set this user's trader status to '${status}'?`)) return;

      try {
        // Corrected endpoint for admin trader status update
        const res = await fetch(`/admin/financials/api/traders/${userId}/status`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: status })
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Failed to update trader status: ${res.status} - ${errorText}`);
        }

        alert(`Trader status updated to '${status}' successfully!`);
        fetchSubscriptions(); // Refresh table
      } catch (err) {
        console.error("Error updating trader status:", err);
        alert("Error: " + err.message);
      }
    }

    // Load subscriptions on page load
    document.addEventListener('DOMContentLoaded', fetchSubscriptions);
  </script>
</body>

</html>