<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader Subscription Plans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/sidebar.css">
    <link rel="stylesheet" href="/static/admin_subscription_plans.css">
</head>

<body>
    <div class="wrapper">
        {{template "admin_sidebar" .}}
        <div id="content">
            <h2 class="mb-4">Trader Subscription Plans</h2>

            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#planModal" onclick="resetForm()">
                    <i class="fas fa-plus"></i> Add Plan
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Duration</th>
                            <th>Interval</th>
                            <th>Max Followers</th>
                            <th>Is Trader Plan</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="plans-table-body">
                        <tr><td colspan="10" class="text-center text-muted">Loading plans...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planModalLabel">Add New Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="planForm">
                        <input type="hidden" id="planId">

                        <div class="mb-3">
                            <label for="planName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="planName" required>
                        </div>

                        <div class="mb-3">
                            <label for="planDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="planDescription" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="planPrice" class="form-label">Price</label>
                            <input type="number" class="form-control" id="planPrice" step="0.01" required>
                        </div>

                        <div class="mb-3">
                            <label for="planDuration" class="form-label">Duration (days)</label>
                            <input type="number" class="form-control" id="planDuration" required>
                        </div>

                        <div class="mb-3">
                            <label for="planInterval" class="form-label">Interval</label>
                            <select class="form-select" id="planInterval" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="planMaxFollowers" class="form-label">Max Followers</label>
                            <input type="number" class="form-control" id="planMaxFollowers" value="0">
                        </div>

                        <div class="mb-3">
                            <label for="planIsTraderPlan" class="form-label">Is Trader Plan?</label>
                            <select class="form-select" id="planIsTraderPlan" required>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="planIsActive" class="form-label">Status</label>
                            <select class="form-select" id="planIsActive" required>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-success w-100">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = "http://localhost:8080/admin/api/subscription-plans";
        const planModal = new bootstrap.Modal(document.getElementById('planModal'));

        function getAuthHeaders() {
            const token = localStorage.getItem("adminToken") || "DUMMY_TOKEN";
            return {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
            };
        }

        async function fetchSubscriptionPlans() {
            const tbody = document.getElementById("plans-table-body");
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Loading plans...</td></tr>';
            try {
                const res = await fetch(API_BASE, { method: "GET", headers: getAuthHeaders() });
                if (!res.ok) throw new Error(await res.text());
                const plans = await res.json();
                renderPlans(plans);
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Failed to load plans: ${err.message}</td></tr>`;
            }
        }

        function renderPlans(plans) {
            const tbody = document.getElementById("plans-table-body");
            tbody.innerHTML = "";
            if (!Array.isArray(plans) || plans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No plans found</td></tr>';
                return;
            }

            const fragment = document.createDocumentFragment();
            plans.forEach(plan => {
                const tr = document.createElement("tr");
                const status = plan.is_active ? 'Active' : 'Inactive';
                const traderPlan = plan.is_trader_plan ? 'Yes' : 'No';
                tr.innerHTML = `
                    <td>${plan.ID}</td>
                    <td>${plan.name || '-'}</td>
                    <td>${plan.description || '-'}</td>
                    <td>$${plan.price?.toFixed(2) || '0.00'}</td>
                    <td>${plan.duration || '-'}</td>
                    <td>${plan.interval || '-'}</td>
                    <td>${plan.max_followers || 'Unlimited'}</td>
                    <td>${traderPlan}</td>
                    <td>${status}</td>
                    <!--<td>
                        <button class="btn btn-sm btn-primary me-1" data-id="${plan.ID}" data-action="edit">Edit</button>
                        <button class="btn btn-sm btn-danger" data-id="${plan.ID}" data-action="delete">Delete</button>
                    </td> -->

                    <td class="text-end pe-3">
                    <button 
                        class="btn btn-sm btn-primary me-1" 
                        data-id="${plan.ID}" 
                        data-action="edit" 
                        title="Edit Plan">
                        <i class="fas fa-pencil-alt me-1"></i>
                    </button>
                    <button 
                        class="btn btn-sm btn-danger" 
                        data-id="${plan.ID}" 
                        data-action="delete" 
                        title="Delete Plan">
                        <i class="fas fa-trash-alt me-1"></i>
                    </button>
                    </td>

                `;
                fragment.appendChild(tr);
            });
            tbody.appendChild(fragment);
        }

        function resetForm() {
            const form = document.getElementById("planForm");
            form.reset();
            document.getElementById("planId").value = "";
            document.getElementById("planModalLabel").textContent = "Add New Plan";
        }

        async function editPlan(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}`, { headers: getAuthHeaders() });
                if (!res.ok) throw new Error(await res.text());
                const plan = await res.json();

                document.getElementById("planId").value = plan.ID;
                document.getElementById("planName").value = plan.name;
                document.getElementById("planPrice").value = plan.price;
                document.getElementById("planDescription").value = plan.description || "";
                document.getElementById("planDuration").value = plan.duration;
                document.getElementById("planInterval").value = plan.interval;
                document.getElementById("planMaxFollowers").value = plan.max_followers;
                document.getElementById("planIsTraderPlan").value = String(plan.is_trader_plan);
                document.getElementById("planIsActive").value = String(plan.is_active);
                planModal.show();
            } catch (err) {
                console.error(err);
                alert("Failed to load plan: " + err.message);
            }
        }

        async function deletePlan(id) {
            if (!confirm("Are you sure you want to delete this plan?")) return;
            try {
                const res = await fetch(`${API_BASE}/${id}`, { method: "DELETE", headers: getAuthHeaders() });
                if (!res.ok) throw new Error(await res.text());
                fetchSubscriptionPlans();
            } catch (err) {
                console.error(err);
                alert("Failed to delete plan: " + err.message);
            }
        }

        document.getElementById("planForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("planId").value;
            const planData = {
                name: document.getElementById("planName").value.trim(),
                price: parseFloat(document.getElementById("planPrice").value),
                description: document.getElementById("planDescription").value.trim(),
                duration: parseInt(document.getElementById("planDuration").value),
                interval: document.getElementById("planInterval").value,
                max_followers: parseInt(document.getElementById("planMaxFollowers").value) || 0,
                is_trader_plan: document.getElementById("planIsTraderPlan").value === "true",
                is_active: document.getElementById("planIsActive").value === "true",
            };

            try {
                const method = id ? "PUT" : "POST";
                const url = id ? `${API_BASE}/${id}` : API_BASE;
                const res = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(planData),
                });
                if (!res.ok) throw new Error(await res.text());
                planModal.hide();
                fetchSubscriptionPlans();
            } catch (err) {
                console.error(err);
                alert("Failed to save plan: " + err.message);
            }
        });

        document.getElementById("plans-table-body").addEventListener("click", (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.dataset.action === "edit") editPlan(id);
            if (btn.dataset.action === "delete") deletePlan(id);
        });

        document.addEventListener('DOMContentLoaded', fetchSubscriptionPlans);
    </script>
</body>

</html>
