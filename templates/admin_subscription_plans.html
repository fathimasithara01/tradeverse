<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader Subscription Plans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/static/sidebar.css">

    <style>


        #content {
            flex-grow: 1;
            padding: 2.5rem;
            overflow-x: auto; /* Allow horizontal scrolling for table */
        }

        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }

        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-card .title {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="wrapper">
         {{template "admin_sidebar" .}}
        <div id="content">
            <h2 class="mb-4">Trader Subscription Plans</h2>

            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#planModal" onclick="resetForm()">
                    <i class="fas fa-plus"></i> Add Plan
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Duration</th>
                            <th>Interval</th>
                            <th>Max Followers</th>
                            <th>Is Trader Plan</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="plans-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planModalLabel">Add New Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="planForm">
                        <input type="hidden" id="planId">

                        <div class="mb-3">
                            <label for="planName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="planName" required>
                        </div>

                        <div class="mb-3">
                            <label for="planDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="planDescription" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="planPrice" class="form-label">Price</label>
                            <input type="number" class="form-control" id="planPrice" step="0.01" required>
                        </div>

                        <div class="mb-3">
                            <label for="planDuration" class="form-label">Duration (days)</label>
                            <input type="number" class="form-control" id="planDuration" required>
                        </div>

                        <div class="mb-3">
                            <label for="planInterval" class="form-label">Interval</label>
                            <select class="form-select" id="planInterval" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="planMaxFollowers" class="form-label">Max Followers</label>
                            <input type="number" class="form-control" id="planMaxFollowers" value="0">
                        </div>

                        <div class="mb-3">
                            <label for="planIsTraderPlan" class="form-label">Is Trader Plan?</label>
                            <select class="form-select" id="planIsTraderPlan" required>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="planIsActive" class="form-label">Status</label>
                            <select class="form-select" id="planIsActive" required>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="planFeatures" class="form-label">Features (JSON or comma-separated)</label>
                            <textarea class="form-control" id="planFeatures" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="planCommissionRate" class="form-label">Commission Rate (e.g., 0.05 for 5%)</label>
                            <input type="number" class="form-control" id="planCommissionRate" step="0.0001"
                                value="0.00">
                        </div>

                        <div class="mb-3">
                            <label for="planAnalyticsAccess" class="form-label">Analytics Access</label>
                            <input type="text" class="form-control" id="planAnalyticsAccess">
                        </div>


                        <button type="submit" class="btn btn-success w-100">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
const API_BASE = "http://localhost:8080/admin/financials/api/subscription-plans";
const planModal = new bootstrap.Modal(document.getElementById('planModal'));

function getAuthHeaders() {
    
    let token = localStorage.getItem("adminToken") || "DUMMY_TOKEN"; 
    return {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`,
    };
}

async function fetchSubscriptionPlans() {
    const tbody = document.getElementById("plans-table-body");
    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Loading plans...</td></tr>';
    try {
        const res = await fetch(API_BASE, { method: "GET", headers: getAuthHeaders() });
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Failed to fetch plans: ${res.status} ${res.statusText} - ${errorText}`);
        }
        const plans = await res.json();
        renderPlans(plans);
    } catch (err) {
        console.error("Error fetching subscription plans:", err);
        tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Failed to load plans: ${err.message}</td></tr>`;
        alert("Failed to load plans: " + err.message); // Provide user feedback
    }
}

// Render plans into table
function renderPlans(plans) {
    const tbody = document.getElementById("plans-table-body");
    tbody.innerHTML = "";
    if (!Array.isArray(plans) || plans.length === 0) { // Check if plans is an array and not empty
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No plans found</td></tr>';
        return;
    }

    plans.forEach(plan => {
        const status = plan.is_active ? 'Active' : 'Inactive';
        const traderPlan = plan.is_trader_plan ? 'Yes' : 'No';
        // Sanitize features for display if it's JSON
        let displayFeatures = plan.features;
        try {
            const parsedFeatures = JSON.parse(plan.features);
            displayFeatures = Array.isArray(parsedFeatures) ? parsedFeatures.join(', ') : plan.features;
        } catch (e) {
            // Not valid JSON, display as is
        }

        tbody.innerHTML += `
        <tr>
            <td>${plan.ID}</td>
            <td>${plan.name}</td>
            <td>${plan.description || "-"}</td>
            <td>$${plan.price ? plan.price.toFixed(2) : '0.00'}</td>
            <td>${plan.duration || "-"}</td>
            <td>${plan.interval || "-"}</td>
            <td>${plan.max_followers || "Unlimited"}</td>
            <td>${traderPlan}</td>
            <td>${status}</td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="editPlan(${plan.ID})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deletePlan(${plan.ID})">Delete</button>
            </td>
        </tr>`;
    });
}

// Reset form
function resetForm() {
    document.getElementById("planForm").reset();
    document.getElementById("planId").value = "";
    document.getElementById("planModalLabel").textContent = "Add New Plan";
}

// Edit plan
async function editPlan(id) {
    try {
        const res = await fetch(`${API_BASE}/${id}`, { headers: getAuthHeaders() });
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Failed to fetch plan: ${res.status} ${res.statusText} - ${errorText}`);
        }
        const plan = await res.json();
        document.getElementById("planId").value = plan.ID;
        document.getElementById("planName").value = plan.name;
        document.getElementById("planPrice").value = plan.price;
        document.getElementById("planDescription").value = plan.description || "";
        document.getElementById("planDuration").value = plan.duration;
        document.getElementById("planInterval").value = plan.interval;
        document.getElementById("planMaxFollowers").value = plan.max_followers;
        document.getElementById("planIsTraderPlan").value = String(plan.is_trader_plan); // Convert boolean to string for select
        document.getElementById("planIsActive").value = String(plan.is_active); // Convert boolean to string for select
        document.getElementById("planFeatures").value = plan.features || "";
        document.getElementById("planCommissionRate").value = plan.commission_rate || "0.00";
        document.getElementById("planAnalyticsAccess").value = plan.analytics_access || "";
        document.getElementById("planModalLabel").textContent = "Edit Plan";
        planModal.show();
    } catch (err) {
        console.error("Error editing plan:", err);
        alert("Failed to load plan: " + err.message);
    }
}

// Delete plan
async function deletePlan(id) {
    if (!confirm("Are you sure you want to delete this plan? This action cannot be undone.")) return;
    try {
        const res = await fetch(`${API_BASE}/${id}`, { method: "DELETE", headers: getAuthHeaders() });
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Failed to delete plan: ${res.status} ${res.statusText} - ${errorText}`);
        }
        fetchSubscriptionPlans();
    } catch (err) {
        console.error("Error deleting plan:", err);
        alert("Failed to delete plan: " + err.message);
    }
}

// Save plan (create or update)
document.getElementById("planForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("planId").value;

    // Basic validation
    const planName = document.getElementById("planName").value.trim();
    const planPrice = parseFloat(document.getElementById("planPrice").value);
    const planDuration = parseInt(document.getElementById("planDuration").value);

    if (!planName) {
        alert("Plan Name is required.");
        return;
    }
    if (isNaN(planPrice) || planPrice < 0) {
        alert("Price must be a non-negative number.");
        return;
    }
    if (isNaN(planDuration) || planDuration <= 0) {
        alert("Duration must be a positive number of days.");
        return;
    }


    const planData = {
        name: planName,
        price: planPrice,
        description: document.getElementById("planDescription").value.trim(),
        duration: planDuration,
        interval: document.getElementById("planInterval").value,
        max_followers: parseInt(document.getElementById("planMaxFollowers").value) || 0,
        is_trader_plan: document.getElementById("planIsTraderPlan").value === "true",
        is_active: document.getElementById("planIsActive").value === "true",
        features: document.getElementById("planFeatures").value.trim(),
        commission_rate: parseFloat(document.getElementById("planCommissionRate").value) || 0.00,
        analytics_access: document.getElementById("planAnalyticsAccess").value.trim(),
    };

    try {
        const method = id ? "PUT" : "POST";
        const url = id ? `${API_BASE}/${id}` : API_BASE;
        const res = await fetch(url, {
            method: method,
            headers: getAuthHeaders(),
            body: JSON.stringify(planData),
        });
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Failed to save plan: ${res.status} ${res.statusText} - ${errorText}`);
        }
        planModal.hide();
        fetchSubscriptionPlans();
    } catch (err) {
        console.error("Error saving plan:", err);
        alert("Failed to save plan: " + err.message);
    }
});

// Initial load
document.addEventListener('DOMContentLoaded', fetchSubscriptionPlans);
</script>


</body>

</html>