<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader Subscription Plans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>

<body>
    <div class="container mt-5">
      
        <h2 class="text-center mb-4">Trader Subscription Plans</h2>

        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#planModal" onclick="resetForm()">
                <i class="fas fa-plus"></i> Add Plan
            </button>
        </div>

        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Duration</th>
                    <th>Interval</th>
                    <th>Max Followers</th>
                    <th>Is Trader Plan</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="plans-table-body">
                <!-- Plans will be inserted dynamically -->
            </tbody>
        </table>
    </div>

    <!-- Add/Edit Plan Modal -->
    <div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planModalLabel">Add New Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="planForm">
                        <input type="hidden" id="planId">

                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="planName" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="planDescription" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" id="planPrice" step="0.01" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Duration (days)</label>
                            <input type="number" class="form-control" id="planDuration" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Interval</label>
                            <select class="form-select" id="planInterval" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Max Followers</label>
                            <input type="number" class="form-control" id="planMaxFollowers" value="0">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Is Trader Plan?</label>
                            <select class="form-select" id="planIsTraderPlan" required>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="planIsActive" required>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Features (JSON or comma-separated)</label>
                            <textarea class="form-control" id="planFeatures" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Commission Rate (e.g., 0.05 for 5%)</label>
                            <input type="number" class="form-control" id="planCommissionRate" step="0.0001"
                                value="0.00">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Analytics Access</label>
                            <input type="text" class="form-control" id="planAnalyticsAccess">
                        </div>


                        <button type="submit" class="btn btn-success w-100">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = "http://localhost:8080/admin/financials/api/subscription-plans";
        const planModal = new bootstrap.Modal(document.getElementById('planModal'));

        // Utility to get JWT token (adjust based on how you store it)
        function getAuthHeaders() {
            const token = localStorage.getItem("adminToken"); // Assuming you store admin token
            return {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
            };
        }

        // Fetch all plans
        async function fetchSubscriptionPlans() {
            try {
                const res = await fetch(API_BASE, {
                    method: "GET",
                    headers: getAuthHeaders(),
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`Failed to fetch: ${res.status} - ${errorData.error || res.statusText}`);
                }

                const plans = await res.json();
                renderPlans(plans);
            } catch (err) {
                console.error("Error fetching plans:", err);
                alert("Failed to load plans: " + err.message);
            }
        }

        // Render plans into table
        function renderPlans(plans) {
            const tbody = document.getElementById("plans-table-body"); // Corrected ID
            tbody.innerHTML = "";

            if (plans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No subscription plans found.</td></tr>';
                return;
            }

            plans.forEach(plan => {
                const statusText = plan.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">Inactive</span>';
                const isTraderPlanText = plan.is_trader_plan ? 'Yes' : 'No';

                tbody.innerHTML += `
      <tr>
        <td>${plan.ID}</td>
        <td>${plan.name}</td>
        <td>${plan.description || ""}</td>
        <td>${plan.price.toFixed(2)}</td>
        <td>${plan.duration} days</td>
        <td>${plan.interval}</td>
        <td>${plan.max_followers || 'N/A'}</td>
        <td>${isTraderPlanText}</td>
        <td>${statusText}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editPlan(${plan.ID})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deletePlan(${plan.ID})">Delete</button>
        </td>
      </tr>
    `;
            });
        }

        // Reset form fields for adding a new plan
        function resetForm() {
            document.getElementById("planId").value = "";
            document.getElementById("planName").value = "";
            document.getElementById("planDescription").value = "";
            document.getElementById("planPrice").value = "";
            document.getElementById("planDuration").value = "";
            document.getElementById("planInterval").value = "daily";
            document.getElementById("planMaxFollowers").value = "0";
            document.getElementById("planIsTraderPlan").value = "true";
            document.getElementById("planIsActive").value = "true";
            document.getElementById("planFeatures").value = "";
            document.getElementById("planCommissionRate").value = "0.00";
            document.getElementById("planAnalyticsAccess").value = "";
            document.getElementById("planModalLabel").textContent = "Add New Plan";
        }

        // Populate form for editing an existing plan
        async function editPlan(planId) {
            try {
                const res = await fetch(`${API_BASE}/${planId}`, {
                    method: "GET",
                    headers: getAuthHeaders(),
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`Failed to fetch plan for edit: ${res.status} - ${errorData.error || res.statusText}`);
                }

                const plan = await res.json();

                document.getElementById("planId").value = plan.ID;
                document.getElementById("planName").value = plan.name;
                document.getElementById("planDescription").value = plan.description;
                document.getElementById("planPrice").value = plan.price;
                document.getElementById("planDuration").value = plan.duration;
                document.getElementById("planInterval").value = plan.interval;
                document.getElementById("planMaxFollowers").value = plan.max_followers;
                document.getElementById("planIsTraderPlan").value = String(plan.is_trader_plan); // Convert boolean to string
                document.getElementById("planIsActive").value = String(plan.is_active);       // Convert boolean to string
                document.getElementById("planFeatures").value = plan.features || "";
                document.getElementById("planCommissionRate").value = plan.commission_rate || "0.00";
                document.getElementById("planAnalyticsAccess").value = plan.analytics_access || "";

                document.getElementById("planModalLabel").textContent = "Edit Plan";
                planModal.show();
            } catch (err) {
                console.error("Error editing plan:", err);
                alert("Failed to load plan for editing: " + err.message);
            }
        }


        // Add or Update plan
        async function savePlan(planData, planId = null) {
            const method = planId ? "PUT" : "POST";
            const url = planId ? `${API_BASE}/${planId}` : API_BASE;

            try {
                const res = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(planData),
                });

                if (!res.ok) {
                    const errorData = await res.json(); // Attempt to read specific error from JSON
                    const errorMessage = errorData.Message || errorData.error || `Failed with status: ${res.status}`;
                    throw new Error(errorMessage);
                }

                await fetchSubscriptionPlans(); // refresh table
                planModal.hide(); // Close modal on success
                alert("Plan saved successfully!");
            } catch (err) {
                console.error("Error saving plan:", err);
                alert(`Error saving plan: ${err.message}`);
            }
        }

        // Delete plan
        async function deletePlan(planId) {
            if (!confirm("Are you sure you want to delete this plan? This action cannot be undone.")) return;

            try {
                const res = await fetch(`${API_BASE}/${planId}`, {
                    method: "DELETE",
                    headers: getAuthHeaders(),
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(`Failed to delete plan: ${res.status} - ${errorData.error || res.statusText}`);
                }

                fetchSubscriptionPlans();
                alert("Plan deleted successfully!");
            } catch (err) {
                console.error("Error deleting plan:", err);
                alert(err.message);
            }
        }

        // Example usage for form submit
        document.getElementById("planForm").addEventListener("submit", async e => { // Added async
            e.preventDefault();

            const planId = document.getElementById("planId").value; // Get planId for update

            const planData = {
                name: document.getElementById("planName").value,
                description: document.getElementById("planDescription").value,
                price: parseFloat(document.getElementById("planPrice").value),
                duration: parseInt(document.getElementById("planDuration").value, 10),
                interval: document.getElementById("planInterval").value,
                max_followers: parseInt(document.getElementById("planMaxFollowers").value, 10),
                is_trader_plan: document.getElementById("planIsTraderPlan").value === "true", // Convert string to boolean
                is_active: document.getElementById("planIsActive").value === "true",           // Convert string to boolean
                features: document.getElementById("planFeatures").value,
                commission_rate: parseFloat(document.getElementById("planCommissionRate").value),
                analytics_access: document.getElementById("planAnalyticsAccess").value,
            };

            await savePlan(planData, planId ? parseInt(planId, 10) : null); // Pass planId if it exists
        });

        // Load plans on page load
        document.addEventListener("DOMContentLoaded", fetchSubscriptionPlans);
    </script>

</body>

</html>