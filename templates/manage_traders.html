<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Admin - Manage Traders</title>
  <!-- Bootstrap CSS for styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Google Fonts for 'Inter' -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Custom CSS for sidebar (assuming this file exists in /static/) -->
  <link rel="stylesheet" href="/static/sidebar.css">
  <!-- Custom CSS for manage_traders page (assuming this file exists in /static/) -->
  <link rel="stylesheet" href="/static/manage_traders.css">
</head>

<body>
  <div class="wrapper">
    <!-- Template for the admin sidebar - this will be injected by the Go backend -->
    {{template "admin_sidebar" .}}

    <div id="content" class="container-fluid p-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="card-title mb-0">Manage Traders (Masters)</h4>
          <!-- Button to add a new trader -->
          <a href="/admin/users/traders/add" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i> Add New Trader
          </a>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Start Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="trader-table-body">
                <!-- Initial loading message, replaced by JS -->
                <tr>
                  <td colspan="7" class="text-center">Loading traders...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Delete Confirmation Modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="confirmDeleteModalLabel"><i class="fas fa-trash me-2"></i> Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this trader? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JavaScript Bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Execute script once the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function () {
      const tableBody = document.getElementById('trader-table-body'); // Reference to the table body
      // Initialize Bootstrap modal instance
      const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn'); // Reference to the delete confirmation button in the modal
      
      let deleteTargetRow = null; // Stores the table row element to be removed after successful deletion
      let deleteUserId = null;    // Stores the ID of the user to be deleted

      // Function to fetch trader data from the API and display it in the table
      function fetchAndDisplayTraders() {
        fetch('/admin/api/users/traders') // Make a GET request to the traders API
          .then(res => res.json())       // Parse the JSON response
          .then(traders => {
            tableBody.innerHTML = ''; // Clear existing table rows
            if (!traders || traders.length === 0) {
              // Display a message if no traders are found
              tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No traders found.</td></tr>';
              return;
            }

            // Iterate over each trader and create a table row
            traders.forEach(user => {
              // Determine status badge based on is_blocked property
              const status = user.is_blocked
                ? '<span class="badge bg-danger">Blocked</span>'
                : '<span class="badge bg-success">Active</span>';
              // Format creation date (or 'N/A' if not available)
              const startDate = user.CreatedAt
                ? new Date(user.CreatedAt).toLocaleDateString('en-IN')
                : 'N/A';

              const row = document.createElement('tr'); // Create a new table row element
              row.innerHTML = `
                <td>${user.ID}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.phone}</td>
                <td>${startDate}</td>
                <td>${status}</td>
                <td>
                  <a href="/admin/users/edit/${user.ID}" class="btn btn-sm btn-info me-1" title="Edit">
                    <i class="fas fa-pencil-alt"></i>
                  </a>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${user.ID}" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              `;
              tableBody.appendChild(row); // Add the new row to the table body
            });
          })
          .catch(() => {
            // Display an error message if fetching traders fails
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Failed to load traders.</td></tr>';
          });
      }

      // Event listener for clicks on the table body to handle delete button clicks
      tableBody.addEventListener('click', function (event) {
        // Find if the clicked element or its parent is a delete button
        const deleteButton = event.target.closest('.delete-btn');
        if (deleteButton) {
          deleteUserId = deleteButton.getAttribute('data-id');      // Get the user ID from the data-id attribute
          deleteTargetRow = deleteButton.closest('tr'); // Store the parent row for later removal
          confirmDeleteModal.show();                      // Show the Bootstrap confirmation modal
        }
      });

      // Event listener for the "Delete" button inside the confirmation modal
      confirmDeleteBtn.addEventListener('click', function () {
        if (!deleteUserId) return; // Do nothing if no user ID is set for deletion

        fetch(`/admin/api/users/${deleteUserId}`, { method: 'DELETE' }) // Send a DELETE request to the API
          .then(res => res.json()) // Parse the JSON response
          .then(data => {
            if (data.error) throw new Error(data.error); // Throw an error if the API returns an error

            // Remove the deleted row from the table
            deleteTargetRow.remove();

            // Hide the modal and display a success alert message
            confirmDeleteModal.hide();
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success mt-3';
            alertDiv.textContent = 'Trader deleted successfully.';
            document.querySelector('.card-body').prepend(alertDiv); // Add alert to the top of the card body

            // Automatically hide the alert after 3 seconds
            setTimeout(() => alertDiv.remove(), 3000);
          })
          .catch(error => {
            // Hide the modal and display an error alert message if deletion fails
            confirmDeleteModal.hide();
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger mt-3';
            alertDiv.textContent = `Error: ${error.message}`;
            document.querySelector('.card-body').prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 4000); // Auto-hide after 4 seconds
          });
      });

      // Initial call to fetch and display traders when the page loads
      fetchAndDisplayTraders();
    });
  </script>
</body>

</html>