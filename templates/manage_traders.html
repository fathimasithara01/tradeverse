<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Admin - Manage Traders</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/sidebar.css">
  <link rel="stylesheet" href="/static/manage_traders.css">
</head>

<body>
  <div class="wrapper">
    {{template "admin_sidebar" .}}

    <div id="content" class="container-fluid p-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="card-title mb-0">Manage Traders (Masters)</h4>
          <a href="/admin/users/traders/add" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i> Add New Trader
          </a>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Start Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="trader-table-body">
                <tr>
                  <td colspan="7" class="text-center">Loading traders...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="confirmDeleteModalLabel"><i class="fas fa-trash me-2"></i> Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this trader? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tableBody = document.getElementById('trader-table-body');
      
      const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn'); 
     
      
      let deleteTargetRow = null; 
      let deleteUserId = null;    
      function fetchAndDisplayTraders() {
        fetch('/admin/api/users/traders') 
          .then(res => res.json())     
          .then(traders => {
            tableBody.innerHTML = ''; 
            if (!traders || traders.length === 0) {
              tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No traders found.</td></tr>';
              return;
            }

            traders.forEach(user => {
              const status = user.is_blocked
                ? '<span class="badge bg-danger">Blocked</span>'
                : '<span class="badge bg-success">Active</span>';
              const startDate = user.CreatedAt
                ? new Date(user.CreatedAt).toLocaleDateString('en-IN')
                : 'N/A';

              const row = document.createElement('tr'); 
              row.innerHTML = `
                <td>${user.ID}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.phone}</td>
                <td>${startDate}</td>
                <td>${status}</td>
                <td>
                  <a href="/admin/users/edit/${user.ID}" class="btn btn-sm btn-info me-1" title="Edit">
                    <i class="fas fa-pencil-alt"></i>
                  </a>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="${user.ID}" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              `;
              tableBody.appendChild(row); 
            });
          })
          .catch(() => {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Failed to load traders.</td></tr>';
          });
      }

      tableBody.addEventListener('click', function (event) {
        const deleteButton = event.target.closest('.delete-btn');
        if (deleteButton) {
          deleteUserId = deleteButton.getAttribute('data-id');      
          deleteTargetRow = deleteButton.closest('tr'); 
          confirmDeleteModal.show();             
        }
      });

      confirmDeleteBtn.addEventListener('click', function () {
        if (!deleteUserId) return; 

        fetch(`/admin/api/users/${deleteUserId}`, { method: 'DELETE' }) 
          .then(res => res.json()) 
          .then(data => {
            if (data.error) throw new Error(data.error); 
           
            deleteTargetRow.remove();

            confirmDeleteModal.hide();
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success mt-3';
            alertDiv.textContent = 'Trader deleted successfully.';
            document.querySelector('.card-body').prepend(alertDiv);

            setTimeout(() => alertDiv.remove(), 3000);
          })
          .catch(error => {
            confirmDeleteModal.hide();
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger mt-3';
            alertDiv.textContent = `Error: ${error.message}`;
            document.querySelector('.card-body').prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 4000); 
          });
      });

      fetchAndDisplayTraders();
    });
  </script>
</body>

</html>