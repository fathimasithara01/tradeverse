<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Custom Admin CSS (if any) -->
    <link rel="stylesheet" href="/static/sidebar.css">
    <style>
        .table-responsive {
            margin-top: 20px;
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .status-badge {
            padding: .35em .65em;
            border-radius: .25rem;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            display: inline-block;
        }

        .status-PENDING { background-color: #ffc107; color: #333; } /* Warning yellow */
        .status-SUCCESS { background-color: #28a745; color: #fff; } /* Success green */
        .status-FAILED { background-color: #dc3545; color: #fff; } /* Danger red */
        .status-REJECTED { background-color: #6c757d; color: #fff; } /* Secondary grey */
        .status-REVERSED { background-color: #17a2b8; color: #fff; } /* Info cyan */
        .status-CANCELLED { background-color: #fd7e14; color: #fff; } /* Orange */
        .status-PROCESSING { background-color: #007bff; color: #fff; } /* Primary blue */
        /* Add other status styles as needed */

        .transaction-type-badge {
            padding: .35em .65em;
            border-radius: .25rem;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            display: inline-block;
            background-color: #6f42c1; /* Purple default */
            color: #fff;
        }
        .transaction-type-DEPOSIT { background-color: #28a745; } /* Green */
        .transaction-type-WITHDRAWAL { background-color: #dc3545; } /* Red */
        .transaction-type-trader_revenue { background-color: #007bff; } /* Blue */
        .transaction-type-admin_commission { background-color: #6c757d; } /* Grey */
        .transaction-type-REVERSAL { background-color: #17a2b8; } /* Cyan */
        /* Add more transaction type styles as needed */
    </style>
</head>
<body>
    <!-- Assuming a common admin layout structure (sidebar, navbar) -->
    <div class="wrapper">
        <!-- Sidebar (if you have one) -->
        {{ template "admin_sidebar" . }}

        <div id="content">
            <!-- Navbar (if you have one) -->
            {{/* template "admin_navbar" . */}}

            <div class="container-fluid">
                <h2 class="mt-4">{{ .Title }}</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{{ .Title }}</li>
                    </ol>
                </nav>

                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Customer Transactions Overview</h6>
                    </div>
                    <div class="card-body">
                        <div class="search-container">
                            <input type="text" id="searchQuery" class="form-control" placeholder="Search by User/Transaction details..." style="max-width: 400px;">
                            <button class="btn btn-primary" id="searchButton"><i class="fas fa-search"></i> Search</button>
                            <button class="btn btn-secondary" id="resetButton"><i class="fas fa-redo"></i> Reset</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="customerTransactionsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Currency</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Ref ID</th>
                                        <th>Balance Before</th>
                                        <th>Balance After</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody">
                                    <!-- Transactions will be loaded here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-container">
                            <nav aria-label="Page navigation">
                                <ul class="pagination" id="pagination">
                                    <!-- Pagination will be loaded here by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        let currentPage = 1;
        const limit = 10; // Number of items per page
        let currentSearchQuery = '';

        function fetchTransactions(page, query) {
            const apiUrl = `/admin/api/customer/transactions?page=${page}&limit=${limit}&search=${encodeURIComponent(query)}`;
            console.log("Fetching from:", apiUrl); // Debugging line

            $.ajax({
                url: apiUrl,
                method: 'GET',
                success: function(response) {
                    console.log("API Response:", response); // Debugging line
                    renderTransactions(response.transactions);
                    renderPagination(response.total, response.page, response.limit);
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching transactions:", error);
                    $('#transactionsTableBody').html('<tr><td colspan="13" class="text-center text-danger">Failed to load transactions. Please try again.</td></tr>');
                }
            });
        }

        function renderTransactions(transactions) {
            const tbody = $('#transactionsTableBody');
            tbody.empty(); // Clear existing rows

            if (transactions && transactions.length > 0) {
                transactions.forEach(tx => {
                    const row = `
                        <tr>
                            <td>${tx.id}</td>
                            <td>${tx.user_name}</td>
                            <td>${tx.user_email}</td>
                            <td>${tx.user_phone}</td>
                            <td><span class="transaction-type-badge transaction-type-${tx.transaction_type}">${tx.transaction_type}</span></td>
                            <td>${tx.amount.toFixed(2)}</td>
                            <td>${tx.currency}</td>
                            <td><span class="status-badge status-${tx.status}">${tx.status}</span></td>
                            <td>${new Date(tx.created_at).toLocaleString()}</td>
                            <td>${tx.description || 'N/A'}</td>
                            <td>${tx.reference_id || 'N/A'}</td>
                            <td>${tx.balance_before !== undefined ? tx.balance_before.toFixed(2) : 'N/A'}</td>
                            <td>${tx.balance_after !== undefined ? tx.balance_after.toFixed(2) : 'N/A'}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.html('<tr><td colspan="13" class="text-center">No customer transactions found.</td></tr>');
            }
        }

        function renderPagination(total, currentPage, limit) {
            const paginationUl = $('#pagination');
            paginationUl.empty(); // Clear existing pagination

            const totalPages = Math.ceil(total / limit);

            // Hide pagination if there's only one page
            if (totalPages <= 1) {
                paginationUl.hide();
                return;
            } else {
                paginationUl.show();
            }

            // Previous button
            paginationUl.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">Previous</a>
                </li>
            `);

            // Page numbers
            const maxPagesToShow = 5; // e.g., show 5 page numbers at a time
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            if (startPage > 1) {
                paginationUl.append(`<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`);
                if (startPage > 2) {
                    paginationUl.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationUl.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationUl.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
                }
                paginationUl.append(`<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`);
            }


            // Next button
            paginationUl.append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">Next</a>
                </li>
            `);

            // Add event listeners to new pagination links
            paginationUl.find('.page-link').on('click', function(e) {
                e.preventDefault();
                const newPage = parseInt($(this).data('page'));
                if (!$(this).parent().hasClass('disabled') && newPage > 0 && newPage <= totalPages) {
                    currentPage = newPage;
                    fetchTransactions(currentPage, currentSearchQuery);
                }
            });
        }

        // Initial fetch when the page loads
        $(document).ready(function() {
            fetchTransactions(currentPage, currentSearchQuery);

            $('#searchButton').on('click', function() {
                currentSearchQuery = $('#searchQuery').val().trim(); // Trim whitespace
                currentPage = 1; // Reset to first page on new search
                fetchTransactions(currentPage, currentSearchQuery);
            });

            $('#searchQuery').on('keypress', function(e) {
                if (e.which === 13) { // Enter key pressed
                    $('#searchButton').click();
                }
            });


            $('#resetButton').on('click', function() {
                $('#searchQuery').val(''); // Clear search input
                currentSearchQuery = '';
                currentPage = 1; // Reset to first page
                fetchTransactions(currentPage, currentSearchQuery);
            });
        });
    </script>
</body>
</html>