<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Add User</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/sidebar.css">
    <link rel="stylesheet" href="/static/admin_profile.css">
</head>

<body>
    <div class="wrapper">
        {{template "admin_sidebar" .}}

        <main class="content-area">
            <div class="container py-4">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card shadow-sm position-relative">
                            <!-- Loading Overlay -->
                            <div class="loading-overlay" id="cardLoadingOverlay" role="status"
                                aria-label="Loading profile data">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>

                            <div
                                class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h1 class="mb-0 fs-4">Admin Profile</h1>
                                <!-- Optional: Add an edit/save toggle here if you want distinct view/edit modes --> -->
                                 <!-- <button id="editProfileToggle" class="btn btn-outline-light btn-sm"> 
                                    <i class="fas fa-edit"></i> Edit
                                </button> -->
                            </div> 
                            <div class="card-body">
                                <!-- Profile Update Message -->
                                <div id="profile-message" class="alert d-none" role="status" aria-live="polite">
                                    <!-- Messages like "Profile updated successfully" will appear here -->
                                </div>

                                <form id="profileUpdateForm" enctype="multipart/form-data" novalidate>
                                    <fieldset>
                                        <legend class="visually-hidden">Update Profile Information</legend>
                                        <div class="text-center mb-4">
                                            <div class="profile-pic-wrapper">
                                                <img id="profilePicPreview" src="/static/images/default_profile_pic.png"
                                                    alt="Current Profile Picture"
                                                    class="profile-pic-preview img-thumbnail rounded-circle">
                                                <label for="profilePicInput"
                                                    class="profile-pic-label btn btn-sm btn-light position-absolute bottom-0 end-0 rounded-circle p-2"
                                                    title="Change Profile Picture">
                                                    <i class="fas fa-camera"></i>
                                                    <span class="visually-hidden">Change Profile Picture</span>
                                                </label>
                                                <input type="file" id="profilePicInput" name="profile_pic"
                                                    accept="image/*" class="form-control-file d-none">
                                            </div>
                                            <small class="form-text text-muted">Max file size: 2MB</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="name" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="name" name="name" required
                                                aria-describedby="nameHelp" placeholder="Enter your full name">
                                            <div id="nameHelp" class="form-text">Your public display name.</div>
                                            <div class="invalid-feedback">Please enter your name.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" name="email" required
                                                aria-describedby="emailHelp" placeholder="Enter your email address">
                                            <div id="emailHelp" class="form-text">We'll never share your email with
                                                anyone else.</div>
                                            <div class="invalid-feedback">Please enter a valid email address.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="phone" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="phone" name="phone"
                                                aria-describedby="phoneHelp" placeholder="e.g., +15551234567"
                                                pattern="^\+?[1-9]\d{1,14}$"> <!-- E.164 format suggestion -->
                                            <div id="phoneHelp" class="form-text">Optional phone number.</div>
                                            <div class="invalid-feedback">Please enter a valid phone number (e.g.,
                                                +15551234567).</div>
                                        </div>
                                        <button type="submit" class="btn btn-primary" id="updateProfileBtn">Update
                                            Profile</button>
                                    </fieldset>
                                </form>

                                <hr class="my-4">

                                <h2 class="mb-3 fs-5">Change Password</h2>
                                <form id="passwordChangeForm" novalidate>
                                    <fieldset>
                                        <legend class="visually-hidden">Change Account Password</legend>
                                        <!-- Password Change Message -->
                                        <div id="password-message" class="alert d-none" role="status"
                                            aria-live="polite">
                                            <!-- Messages like "Password changed successfully" will appear here -->
                                        </div>
                                        <div class="mb-3">
                                            <label for="oldPassword" class="form-label">Current Password</label>
                                            <input type="password" class="form-control" id="oldPassword"
                                                name="old_password" required autocomplete="current-password">
                                            <div class="invalid-feedback">Please enter your current password.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="newPassword"
                                                name="new_password" required minlength="8"
                                                pattern="^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+]).{8,}$"
                                                aria-describedby="newPasswordHelp" autocomplete="new-password">
                                            <div id="newPasswordHelp" class="form-text">
                                                Must be at least 8 characters long, contain an uppercase letter, a
                                                lowercase letter, a number, and a special character.
                                            </div>
                                            <div class="invalid-feedback">New password must be at least 8 characters
                                                long and include uppercase, lowercase, a number, and a special
                                                character.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="confirmNewPassword" class="form-label">Confirm New
                                                Password</label>
                                            <input type="password" class="form-control" id="confirmNewPassword"
                                                name="confirm_new_password" required minlength="8"
                                                autocomplete="new-password">
                                            <div class="invalid-feedback">New passwords do not match.</div>
                                        </div>
                                        <button type="submit" class="btn btn-warning" id="changePasswordBtn">Change
                                            Password</button>
                                    </fieldset>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS (bundle includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>

    <!-- Your custom JavaScript -->
    <script>
        // Use an IIFE (Immediately Invoked Function Expression) for scope encapsulation
        (function () {
            // --- Constants and DOM Element References ---
            const DOM = {
                cardLoadingOverlay: document.getElementById('cardLoadingOverlay'),
                profilePicInput: document.getElementById('profilePicInput'),
                profilePicPreview: document.getElementById('profilePicPreview'),
                profileUpdateForm: document.getElementById('profileUpdateForm'),
                profileMessageDiv: document.getElementById('profile-message'),
                nameInput: document.getElementById('name'),
                emailInput: document.getElementById('email'),
                phoneInput: document.getElementById('phone'),
                updateProfileBtn: document.getElementById('updateProfileBtn'),

                passwordChangeForm: document.getElementById('passwordChangeForm'),
                oldPasswordInput: document.getElementById('oldPassword'),
                newPasswordInput: document.getElementById('newPassword'),
                confirmNewPasswordInput: document.getElementById('confirmNewPassword'),
                passwordMessageDiv: document.getElementById('password-message'),
                changePasswordBtn: document.getElementById('changePasswordBtn'),
            };

            const API_ENDPOINTS = {
                PROFILE: '/admin/api/profile',
                PASSWORD_CHANGE: '/admin/api/profile/password',
            };

            const DEFAULT_PROFILE_PIC = '/static/images/default_profile_pic.png';
            const MESSAGE_TIMEOUT_MS = 5000; // 5 seconds

            // --- Utility Functions ---

            /**
             * Toggles a loading state on a given button and the main card overlay.
             * @param {HTMLButtonElement} button - The button to disable/enable and show spinner on.
             * @param {boolean} show - True to show loading, false to hide.
             */
            const toggleLoadingState = (button, show) => {
                if (button) {
                    button.disabled = show;
                    button.innerHTML = show
                        ? `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`
                        : button.dataset.originalText || button.textContent; // Restore original text
                    if (!button.dataset.originalText) {
                        button.dataset.originalText = button.textContent;
                    }
                }
                if (DOM.cardLoadingOverlay) {
                    DOM.cardLoadingOverlay.classList.toggle('active', show);
                }
            };

            /**
             * Displays an alert message.
             * @param {HTMLElement} alertDiv - The div element to show the alert in.
             * @param {'success'|'danger'|'warning'|'info'} type - Bootstrap alert type.
             * @param {string} message - The message to display.
             */
            const showAlert = (alertDiv, type, message) => {
                if (!alertDiv) return;

                // Clear previous classes and content
                alertDiv.className = 'alert';
                alertDiv.classList.add(`alert-${type}`);
                alertDiv.textContent = message; // Use textContent to prevent XSS
                alertDiv.setAttribute('role', 'alert'); // Announce to screen readers

                alertDiv.classList.remove('d-none', 'fade', 'show'); // Ensure it's not hidden
                // Force reflow for fade-in animation
                void alertDiv.offsetWidth;
                alertDiv.classList.add('show'); // Trigger Bootstrap fade-in

                clearTimeout(alertDiv.dataset.hideTimeout); // Clear any existing timeout

                alertDiv.dataset.hideTimeout = setTimeout(() => {
                    alertDiv.classList.remove('show'); // Trigger fade-out
                    alertDiv.classList.add('fade'); // Ensure fade class for transition

                    const handleTransitionEnd = () => {
                        alertDiv.classList.add('d-none'); // Hide completely after fade
                        alertDiv.classList.remove('fade'); // Clean up
                        alertDiv.removeEventListener('transitionend', handleTransitionEnd);
                    };
                    alertDiv.addEventListener('transitionend', handleTransitionEnd, { once: true });
                }, MESSAGE_TIMEOUT_MS);
            };

            /**
             * Clears an alert message.
             * @param {HTMLElement} alertDiv - The div element of the alert.
             */
            const clearAlert = (alertDiv) => {
                if (alertDiv) {
                    clearTimeout(alertDiv.dataset.hideTimeout);
                    alertDiv.classList.add('d-none');
                    alertDiv.classList.remove('show', 'fade');
                    alertDiv.removeAttribute('role');
                    alertDiv.textContent = '';
                }
            };

            /**
             * Handles form validation feedback using Bootstrap's built-in styles.
             * @param {HTMLFormElement} form - The form to validate.
             * @param {boolean} isValid - Whether the form is currently valid.
             */
            const handleValidationFeedback = (form, isValid) => {
                form.classList.toggle('was-validated', !isValid);
            };

            // --- API Interaction ---

            /**
             * Generic function to fetch JSON data from an API endpoint.
             * @param {string} url - The API endpoint URL.
             * @param {object} options - Fetch options (method, headers, body, etc.).
             * @param {HTMLButtonElement} [button] - Optional button to apply loading state.
             * @returns {Promise<object>} - The JSON response data.
             * @throws {Error} - If the network request fails or the server returns an error.
             */
            async function fetchJson(url, options = {}, button = null) {
                toggleLoadingState(button, true); // Show loading
                try {
                    const response = await fetch(url, options);
                    const data = await response.json();

                    if (!response.ok) {
                        const errorMessage = data.error || data.message || `HTTP error! Status: ${response.status}`;
                        throw new Error(errorMessage);
                    }
                    return data;
                } finally {
                    toggleLoadingState(button, false); // Hide loading
                }
            }

            // --- Profile Management ---

            /**
             * Fetches and displays the admin profile data.
             */
            async function fetchAdminProfile() {
                try {
                    const data = await fetchJson(API_ENDPOINTS.PROFILE);
                    DOM.nameInput.value = data.name || '';
                    DOM.emailInput.value = data.email || '';
                    DOM.phoneInput.value = data.phone || '';
                    // Ensure the profile picture path is correctly handled
                    DOM.profilePicPreview.src = data.profile_pic ? data.profile_pic : DEFAULT_PROFILE_PIC;
                    clearAlert(DOM.profileMessageDiv); // Clear any stale alerts on load
                } catch (error) {
                    console.error('Error fetching admin profile:', error);
                    showAlert(DOM.profileMessageDiv, 'danger', `Failed to load profile: ${error.message}`);
                }
            }

            /**
             * Handles the change event for the profile picture input.
             */
            function handleProfilePicChange() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    const maxFileSize = 2 * 1024 * 1024; // 2MB

                    if (file.size > maxFileSize) {
                        showAlert(DOM.profileMessageDiv, 'danger', 'Profile picture size exceeds 2MB limit.');
                        this.value = ''; // Clear the input
                        DOM.profilePicPreview.src = DEFAULT_PROFILE_PIC; // Reset preview
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => DOM.profilePicPreview.src = e.target.result;
                    reader.readAsDataURL(file);
                } else {
                    // If no file is selected (e.g., user cancels dialog), revert to current or default
                    // This might require storing the original image URL or re-fetching
                    // For simplicity, we'll revert to default here.
                    DOM.profilePicPreview.src = DEFAULT_PROFILE_PIC;
                }
            }

            /**
             * Handles the submission of the profile update form.
             * @param {Event} e - The submit event.
             */
            async function handleProfileUpdate(e) {
                e.preventDefault();
                clearAlert(DOM.profileMessageDiv);

                if (!this.checkValidity()) {
                    handleValidationFeedback(this, false);
                    showAlert(DOM.profileMessageDiv, 'danger', 'Please fill in all required fields correctly.');
                    return;
                }
                handleValidationFeedback(this, true); // Clear previous invalid states

                const formData = new FormData(this);

                try {
                    const result = await fetchJson(API_ENDPOINTS.PROFILE, {
                        method: 'PUT', // Use PUT for updates, more RESTful
                        body: formData,
                    }, DOM.updateProfileBtn);
                    showAlert(DOM.profileMessageDiv, 'success', result.message || 'Profile updated successfully!');
                    await fetchAdminProfile(); // Reload profile to reflect changes, especially new pic
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showAlert(DOM.profileMessageDiv, 'danger', `Failed to update profile: ${error.message}`);
                }
            }

            // --- Password Change ---

            /**
             * Validates the new password fields (match and strength).
             * @returns {boolean} - True if passwords are valid, false otherwise.
             */
            function validatePasswordFields() {
                const newPassword = DOM.newPasswordInput.value;
                const confirmNewPassword = DOM.confirmNewPasswordInput.value;
                // Updated pattern: at least 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special character
                const passwordPattern = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*()_+={}\[\]:;<>,.?~\\-]).{8,}$/;

                let isValid = true;

                // Reset custom validity states
                DOM.newPasswordInput.setCustomValidity('');
                DOM.confirmNewPasswordInput.setCustomValidity('');

                // Check new password strength
                if (!passwordPattern.test(newPassword)) {
                    DOM.newPasswordInput.setCustomValidity('New password does not meet requirements.');
                    isValid = false;
                }

                // Check if passwords match
                if (newPassword !== confirmNewPassword) {
                    DOM.confirmNewPasswordInput.setCustomValidity('Passwords do not match.');
                    isValid = false;
                }


                // Trigger Bootstrap validation display
                // Note: checkValidity() here will apply native validation,
                // but we manually setCustomValidity for more specific feedback.
                DOM.passwordChangeForm.classList.toggle('was-validated', !isValid);

                return isValid && DOM.passwordChangeForm.checkValidity(); // Also check native HTML5 validity
            }

            /**
             * Handles the submission of the password change form.
             * @param {Event} e - The submit event.
             */
            async function handlePasswordChange(e) {
                e.preventDefault();
                clearAlert(DOM.passwordMessageDiv);

                // Re-run validation just before submission
                if (!validatePasswordFields()) {
                    showAlert(DOM.passwordMessageDiv, 'danger', 'Please correct the errors in the password fields.');
                    return;
                }

                const oldPassword = DOM.oldPasswordInput.value;
                const newPassword = DOM.newPasswordInput.value;

                try {
                    const result = await fetchJson(API_ENDPOINTS.PASSWORD_CHANGE, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ old_password: oldPassword, new_password: newPassword }),
                    }, DOM.changePasswordBtn);
                    showAlert(DOM.passwordMessageDiv, 'success', result.message || 'Password changed successfully!');
                    DOM.passwordChangeForm.reset(); // Clear form
                    handleValidationFeedback(DOM.passwordChangeForm, false); // Reset validation states
                } catch (error) {
                    console.error('Error changing password:', error);
                    showAlert(DOM.passwordMessageDiv, 'danger', `Failed to change password: ${error.message}`);
                }
            }

            // --- Event Listeners and Initialization ---

            /**
             * Initializes all event listeners for the page.
             */
            function initializeEventListeners() {
                DOM.profilePicInput.addEventListener('change', handleProfilePicChange);
                DOM.profileUpdateForm.addEventListener('submit', handleProfileUpdate);

                // Add real-time validation for password fields
                DOM.oldPasswordInput.addEventListener('input', () => DOM.passwordChangeForm.checkValidity()); // Simple check
                DOM.newPasswordInput.addEventListener('input', validatePasswordFields);
                DOM.confirmNewPasswordInput.addEventListener('input', validatePasswordFields);
                DOM.passwordChangeForm.addEventListener('submit', handlePasswordChange);
            }

            // Entry point for the script
            document.addEventListener('DOMContentLoaded', () => {
                initializeEventListeners();
                fetchAdminProfile(); // Initial data fetch
            });

        })(); // End of IIFE
    </script>
</body>

</html>