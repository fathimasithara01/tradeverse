<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }} - Admin</title>
    <!-- Include Bootstrap CSS and Font Awesome for icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="/static/sidebar.css">
        <link rel="stylesheet" href="/static/create_signal_card.css">

</head>

<body>
    <div class="wrapper">
      {{ template "admin_sidebar" . }}

        <!-- Page Content -->
        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded shadow-sm">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-info d-none d-md-block">
                        <i class="fas fa-align-left"></i>
                        <span>Toggle Sidebar</span>
                    </button>
                    <h2 class="mb-0 ms-3">{{ .Title }}</h2>
                    <div class="ms-auto me-3">
                        <a href="/admin/signals" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Signals
                        </a>
                    </div>
                    <!-- Dark Mode Toggle -->
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                        <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                    </div>
                </div>
            </nav>

            <div class="container-fluid">
                <div class="card">
                    <div class="card-header">
                        <h5>Create New Signal Card</h5>
                    </div>
                    <div class="card-body">
                        <form id="createSignalForm">
                            <div class="mb-3">
                                <label for="traderName" class="form-label">Trader Name</label>
                                <input type="text" class="form-control" id="traderName" name="traderName"
                                    placeholder="e.g., TraderOne" required>
                            </div>
                            <div class="mb-3">
                                <label for="symbol" class="form-label">Symbol (e.g., BTCUSDT)</label>
                                <input type="text" class="form-control" id="symbol" name="symbol"
                                    placeholder="e.g., BTCUSDT" required>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="stopLoss" class="form-label">Stop Loss ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="stopLoss" name="stopLoss"
                                        placeholder="e.g., 43000" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="entryPrice" class="form-label">Entry Price ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="entryPrice"
                                        name="entryPrice" placeholder="e.g., 45000" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="targetPrice" class="form-label">Target Price ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="targetPrice"
                                        name="targetPrice" placeholder="e.g., 50000" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="currentPrice" class="form-label">Current Price ($)</label>
                                <input type="number" step="0.0001" class="form-control" id="currentPrice"
                                    name="currentPrice" placeholder="e.g., 0.006184" value="0" readonly>
                                <small class="form-text text-muted">This will be auto-updated by the system from market
                                    data.</small>
                            </div>
                            <div class="mb-3">
                                <label for="strategy" class="form-label">Strategy</label>
                                <select class="form-select" id="strategy" name="strategy" required>
                                    <option selected disabled value="">Choose...</option>
                                    <option value="Day Trading">Day Trading</option>
                                    <option value="Scalping">Scalping</option>
                                    <option value="Swing Trading">Swing Trading</option>
                                    <option value="Long Term">Long Term</option>
                                    <option value="Futures Trading">Futures Trading</option>
                                    <option value="Spot Trading">Spot Trading</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="risk" class="form-label">Risk Level</label>
                                <select class="form-select" id="risk" name="risk" required>
                                    <option selected disabled value="">Choose...</option>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Very High">Very High</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="startDate" class="form-label">Trade Start Date</label>
                                    <input type="date" class="form-control" id="startDate" name="startDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="endDate" class="form-label">Trade End Date</label>
                                    <input type="date" class="form-control" id="endDate" name="endDate" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="totalDuration" class="form-label">Total Duration (e.g., 4 weeks 2
                                    days)</label>
                                <input type="text" class="form-control" id="totalDuration" name="totalDuration" readonly
                                    placeholder="Auto-calculated">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Create Signal
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            // Sidebar collapse functionality
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
                $('#content').toggleClass('active'); // Adjust content width
            });

            // Dark Mode Toggle Functionality
            $('#darkModeSwitch').on('change', function () {
                if (this.checked) {
                    $('body').addClass('dark-mode');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    $('body').removeClass('dark-mode');
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            // Check for saved dark mode preference on load
            if (localStorage.getItem('darkMode') === 'enabled') {
                $('#darkModeSwitch').prop('checked', true);
                $('body').addClass('dark-mode');
            }

            // Function to fetch current market price for a given symbol
            function fetchCurrentMarketPrice(symbol, callback) {
                if (!symbol) {
                    $('#currentPrice').val('0'); // Set to 0 if symbol is empty
                    return;
                }
                $.ajax({
                    url: '/admin/api/market-data', // Your endpoint to get market data
                    method: 'GET',
                    success: function (response) {
                        // Assuming response is an array of market data objects and we need to find the specific one
                        const marketData = response.find(item => item.symbol.toUpperCase() === symbol.toUpperCase());
                        if (marketData && typeof marketData.current_price === 'number') {
                            callback(marketData.current_price);
                        } else {
                            console.warn("No market data found for symbol:", symbol);
                            callback(0); // Return 0 if no data found
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Error fetching market data:", textStatus, errorThrown);
                        callback(0); // Indicate failure by returning 0
                    }
                });
            }

            // Fetch current price when symbol changes or input loses focus
            $('#symbol').on('change blur', function () {
                const symbol = $(this).val();
                console.log('#currentPrice').val(price.toFixed(8));

                if (symbol) {
                    fetchCurrentMarketPrice(symbol, function (price) {
                        $('#currentPrice').val(price.toFixed(8)); // Display with higher precision
                    });
                } else {
                    $('#currentPrice').val('0'); // Set to 0 if symbol field is empty
                }
            });

            // Auto-calculate duration
            $('#startDate, #endDate').on('change', function () {
                const startDateStr = $('#startDate').val();
                const endDateStr = $('#endDate').val();

                if (startDateStr && endDateStr) {
                    const startDate = new Date(startDateStr);
                    const endDate = new Date(endDateStr);

                    // Ensure valid dates and endDate is after startDate
                    if (startDate instanceof Date && !isNaN(startDate) &&
                        endDate instanceof Date && !isNaN(endDate) &&
                        startDate <= endDate) { // Allow start date to be equal to end date for 0 duration
                        const diffTime = Math.abs(endDate.getTime() - startDate.getTime()); // Get difference in milliseconds
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Convert to days

                        if (diffDays === 0) {
                            $('#totalDuration').val('0 days');
                        } else {
                            const years = Math.floor(diffDays / 365);
                            let remainingDays = diffDays % 365;
                            const months = Math.floor(remainingDays / 30); // Approximate months
                            remainingDays %= 30;
                            const weeks = Math.floor(remainingDays / 7);
                            remainingDays %= 7;

                            let durationParts = [];
                            if (years > 0) durationParts.push(`${years} year${years !== 1 ? 's' : ''}`);
                            if (months > 0) durationParts.push(`${months} month${months !== 1 ? 's' : ''}`);
                            if (weeks > 0) durationParts.push(`${weeks} week${weeks !== 1 ? 's' : ''}`);
                            if (remainingDays > 0) durationParts.push(`${remainingDays} day${remainingDays !== 1 ? 's' : ''}`);

                            if (durationParts.length > 0) {
                                $('#totalDuration').val(durationParts.join(' '));
                            } else {
                                $('#totalDuration').val(''); // Should not happen if diffDays > 0
                            }
                        }
                    } else {
                        $('#totalDuration').val(''); // Clear if dates are invalid or endDate < startDate
                    }
                } else {
                    $('#totalDuration').val(''); // Clear if either date is empty
                }
            });


            // Handle form submission
            $('#createSignalForm').on('submit', function (e) {
                e.preventDefault(); // Prevent default form submission

                // Collect form data and ensure numbers are parsed correctly
                const stopLossVal = parseFloat($('#stopLoss').val());
                const entryPriceVal = parseFloat($('#entryPrice').val());
                const targetPriceVal = parseFloat($('#targetPrice').val());
                const currentPriceVal = parseFloat($('#currentPrice').val());

                // Basic validation for numbers
                if (isNaN(stopLossVal) || isNaN(entryPriceVal) || isNaN(targetPriceVal) || isNaN(currentPriceVal)) {
                    alert('Please enter valid numbers for Stop Loss, Entry Price, Target Price, and Current Price.');
                    return;
                }

                const formData = {
                    traderName: $('#traderName').val(),
                    symbol: $('#symbol').val().toUpperCase(), // Ensure symbol is uppercase
                    stopLoss: stopLossVal,
                    entryPrice: entryPriceVal,
                    targetPrice: targetPriceVal,
                    currentPrice: currentPriceVal, // Use the parsed float value
                    strategy: $('#strategy').val(),
                    risk: $('#risk').val(),
                    // Correct ISO 8601 format for Go's time.Parse
                    // Go's default time.Time parsing expects "YYYY-MM-DDTHH:MM:SSZ07:00"
                    // Appending "T00:00:00Z" (for UTC midnight) to a date string works.
                    startDate: $('#startDate').val() ? $('#startDate').val() + "T00:00:00Z" : "",
                    endDate: $('#endDate').val() ? $('#endDate').val() + "T00:00:00Z" : "",
                    totalDuration: $('#totalDuration').val(), // This can be calculated on backend too, but send for consistency
                    status: "Pending" // Initial status set by client, but backend service should confirm/override based on logic
                };

                console.log("Form Data to be sent:", formData);

                $.ajax({
                    url: '/admin/api/signals', // Replace with your actual API endpoint for creating signals
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        alert('Signal created successfully!');
                        // Optionally, redirect to the signals list page
                        window.location.href = '/admin/signals';
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Error creating signal:", textStatus, errorThrown, jqXHR.responseText);
                        let errorMessage = 'Failed to create signal: ' + (jqXHR.responseJSON && jqXHR.responseJSON.error ? jqXHR.responseJSON.error : errorThrown);
                        alert(errorMessage);
                    }
                });
            });
        });
    </script>
</body>

</html>