<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin - Manage Roles</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/sidebar.css">
    <link rel="stylesheet" href="/static/manage_roles.css">

</head>

<body>
    <div class="wrapper">
        {{template "admin_sidebar" .}}


        <div id="content" class="container-fluid p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Roles</h2>
                <div class="btn-group">
                    <a href="/admin/roles/add" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Create Role
                    </a>
                </div>
            </div>
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="ps-4">ID</th>
                                    <th>Name</th>
                                    <th>joined On</th>
                                    <th class="text-end pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="role-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.getElementById('role-table-body');

            function loadRoles() {
                if (!tableBody) {
                    console.error("Fatal Error: Table body with ID 'role-table-body' not found.");
                    return;
                }

                tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Loading roles...</td></tr>';

                fetch('/admin/api/roles')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(roles => {
                        tableBody.innerHTML = ''; 
                        if (!roles || roles.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">No roles have been created yet.</td></tr>';
                            return;
                        }

                        roles.forEach(role => {

                            const startDate = role.CreatedAt
                                ? new Date(role.CreatedAt).toLocaleDateString('en-IN')
                                : 'N/A';
                            const row = document.createElement('tr');

                            const createdByName = role.createdByName || '<span class="text-muted fst-italic">N/A</span>';

                            row.innerHTML = `
                                <td class="ps-4">${role.ID}</td>
                                <td><strong>${role.name}</strong></td>
                                <td>${startDate}</td>

                               <!-- <td class="text-end pe-4">
                                    <a href="/admin/roles/edit/${role.ID}" class="btn btn-sm btn-outline-primary me-2" title="Edit Role">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRole(${role.ID})" title="Delete Role">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td> -->

                                <td class="text-end pe-4">
                                <a href="/admin/roles/edit/${role.ID}" 
                                    title="Edit Role"
                                    style="display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:8px;background-color:#0d6efd;color:#fff;text-decoration:none;margin-left:6px;transition:0.2s;">
                                    <i class="fas fa-pencil-alt"></i>
                                </a>
                                <button 
                                    onclick="deleteRole(${role.ID})" 
                                    title="Delete Role"
                                    style="display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:8px;background-color:#dc3545;color:#fff;border:none;cursor:pointer;margin-left:6px;transition:0.2s;">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                </td>

                      `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching roles:', error);
                        tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-danger">Failed to load roles. Check browser console for details.</td></tr>';
                    });
            }

            // Initial call to load the roles table.
            loadRoles();
        });

        function deleteRole(roleId) {
            if (confirm('Are you sure you want to delete this role? This cannot be undone.')) {
                fetch(`/admin/api/roles/${roleId}`, {
                    method: 'DELETE',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        document.getElementById('role-table-body').innerHTML = '';
                        document.dispatchEvent(new Event('DOMContentLoaded')); // Re-run the loadRoles function
                    })
                    .catch(error => {
                        console.error('Error deleting role:', error);
                        alert(`Failed to delete role: ${error.message}`);
                    });
            }
        }
    </script>
</body>

</html>